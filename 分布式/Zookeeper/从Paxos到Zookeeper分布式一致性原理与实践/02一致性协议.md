# 一致性协议

在分布式系统中，为了保持事务处理的ACID特性，引入一个称为”**协调者**“的组件来统一调度所有分布式节点的执行逻辑，这些被调度的分布式节点则被称为”**参与者**“。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务正真进行提交。

## 2PC

二阶段提交，为了使基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性而设计的一种算法。用来保证分布式系统数据一致性。

### 阶段一：提交事务请求

1. 事务询问

   协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应

2. 执行事务

   各参与者节点执行事务操作，并将Undo和Redo的信息记入事务日志中

3. 各参与者向协调者反馈事务询问的响应

   如果参与者成功的执行了事务操作，那么就反馈给协调者Yes响应，表示事务可以执行；如果参与者没有成功执行事务，那么就反馈给协调者No响应，表示事务不可以执行

### 阶段二：执行事务提交

- 执行事务提交

  假如协调者从所有的参与者获取到的反馈都是Yes响应，那么会执行事务提交

  1. 发送提交请求

     协调者向所有参与者发送Commit请求

  2. 事务提交

     参与者接收到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源。

  3. 反馈事务提交结果

     参与者在完成事务提交之后，向协调者发送Ack消息

  4. 完成事务

     协调者接收到所有参与者反馈的Ack消息后，完成事务

- 中断事务

  假如任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者无法接收到所有参与者的反馈响应，那么就会中断事务

  1. 发送回滚请求

     协调者向所有参与者发送Rollback请求

  2. 事务回滚

     参与者接收到Rollback请求后，会利用一阶段中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源

  3. 反馈事务回滚结果

     参与者在完成事务回滚之后，向协调者发送Ack消息

  4. 中断事务

     协调者接收到所有参与者反馈的Ack消息后，完成事务中断

### 优缺点

- 优点：原理简单、使用方便

- 缺点：同步阻塞、单点问题、脑裂、太过保守

  - 同步阻塞

    在二阶段提交的的过程中，所有参与这个事务操作的逻辑都处于阻塞状态，也就是说各个参与者在等待其他参与者响应的过程中，将无法进行任何操作

  - 单点问题

    协调者在整个二阶段提交的

  - 数据不一致

  - 太过保守

## 3PC

